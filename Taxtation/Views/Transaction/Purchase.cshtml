@model Taxtation.ViewModel.TXTPurchaseDetailView

@{
    ViewData["Title"] = "Purchase Detail";
    var index = 7;
    if (Model.detail.detail != null)
    {
        index = Model.detail.detail.Count;
    }
}
<form asp-action="Purchase" method="post">
    <div class="row" style="position:fixed;padding-top:10px;z-index:2;background-color:#EEEEEE;left:0;right:0">
        <div class="col-sm-12" style="padding-left:8.2%;">
            @if (ViewData["_Save"].ToString() == "True")
            {
                <button type="submit" name="Save" id="Save" value="Save" AccessKey="S" class="form-control-btn buttonsize">S̲AVE</button>
            }
            @if (ViewData["_Update"].ToString() == "True")
            {
                <button type="submit" name="Update" id="Update" value="Update" AccessKey="U" class="form-control-btn buttonsize">U̲PDATE</button>
                <button type="submit" name="Delete" id="Delete" value="Delete" AccessKey="L" class="form-control-btn buttonsize">DEL̲ETE</button>
                <button type="submit" name="Report" id="Report" value="Report" AccessKey="R" class="form-control-btn buttonsize">R̲EPORT</button>
            }
            <button name="Add Row" id="addNewRow" value="Add Row" AccessKey="A" class="form-control-btn buttonsize">A̲DDROW</button>
            <a asp-action="showPurchase" asp-controller="Transaction" AccessKey="B" class="form-control-btn buttonsize">B̲ACK</a>
            <div style="float:right;padding-right:8.3%">
                <table class="w3-table-all">
                    <tr>
                        <td>
                            Sub Total
                            <input type="text" asp-for="SubTotal" readonly="readonly" class="form-control" />
                        </td>
                        <td>
                            Excise Tax
                            <input type="text" asp-for="ExciseTax" readonly="readonly" class="form-control" />
                        </td>
                        <td>
                            VAT Tax&nbsp;&nbsp;&nbsp;
                            <input type="text" asp-for="VAT" readonly="readonly" class="form-control" />
                        </td>
                        <td>
                            Total Amount
                            <input type="text" asp-for="TotalAmount" readonly="readonly" class="form-control" />
                        </td>
                        <td class="hidden">
                            Advance
                            <input type="text" asp-for="Advance" readonly="readonly" class="form-control" />
                        </td>
                        <td>
                            Paid Amount
                            <input type="text" asp-for="Paid" readonly="readonly" class="form-control" />
                        </td>
                        <td>
                            Balance Amount
                            <input type="text" asp-for="TotalBalance" readonly="readonly" class="form-control" />
                        </td>
                    </tr>
                </table>
            </div>

            @*<div class="row" style="position:sticky;z-index:1;color:#000000;right:0;">
                <div class="col-md-2">
                    Sub Total
                    <input type="text" asp-for="SubTotal" readonly="readonly" class="form-control-footer" />
                </div>
                <div class="col-md-1">
                    Exise Tax
                    <input type="text" asp-for="ExciseTax" readonly="readonly" class="form-control-footer" />
                </div>
                <div class="col-md-1">
                    Vat
                    <input type="text" asp-for="VAT" readonly="readonly" class="form-control-footer" />
                </div>
                <div class="col-md-2">
                    Total
                    <input type="text" asp-for="TotalAmount" readonly="readonly" class="form-control-footer" />
                </div>
                <div class="col-md-2">
                    Advance
                    <input type="text" asp-for="Advance" readonly="readonly" class="form-control-footer" />
                </div>
                <div class="col-md-2">
                    Paid
                    <input type="text" asp-for="Paid" readonly="readonly" class="form-control-footer" />
                </div>
                <div class="col-md-2">
                    Balance
                    <input type="text" asp-for="TotalBalance" readonly="readonly" class="form-control-footer" />
                </div>
            </div>*@

        </div>
    </div>
    <div class="row">
        <div class="col-lg-4">
            <input type="text" asp-for="master.Id" hidden="hidden" class="form-control" />
        </div>
        <div class="col-lg-4">
            <input type="text" asp-for="master.UserName" hidden="hidden" class="form-control" />
        </div>
        <div class="col-lg-4">
            <input type="text" asp-for="master.PurId" hidden="hidden" class="form-control" />
        </div>
    </div>
    <div class="row toppadding3">
        <div class="col-md-3">
            Transaction No<span class="mandatory">*</span>:
            <input type="text" asp-for="master.PurPoref" class="form-control" />
        </div>
        <div class="col-md-3">
            Transaction Date<span class="mandatory">*</span>:
            <input type="date" asp-for="master.PurDate" class="form-control" required />
        </div>
        <div class="col-md-3">
            Term<span class="mandatory">*</span>:
            <select asp-for="master.PurPayTerm" class="form-control" required="required">
                <option value="CREDIT">CREDIT</option>
                <option value="CASH">CASH</option>
                <option value="BANK">BANK</option>
            </select>

        </div><div class="col-md-3">
            Cash/Bank<span class="mandatory">*</span>:
            <select asp-for="master.Coaid" class="form-control" >
                <option value="">SELECT ACCOUNT</option>
                @foreach (var j in Model.lstAccount)
                {
                    <option value=@j.Coaid>@j.AccName</option>
                }
            </select>
        </div>
    </div>
    <div class="row">
        <div class="col-md-3">
            Purchase Type:
            <select asp-for="master.PurType" class="form-control" required="required">
                <option value="LOCAL">LOCAL</option>
                <option value="IMPORT">IMPORT</option>
                <option value="EXEMPT">EXEMPT</option>
            </select>
        </div>
        <div class="col-md-3">
            Item Type:
            <select asp-for="master.PurItmType" class="form-control" required="required">
                <option value="LOCAL">LOCAL</option>
                <option value="IMPORT">IMPORTED</option>
            </select>
        </div>
        <div class="col-md-3">
            Cheque No:
            <input type="text" asp-for="master.PurChqNo" class="form-control" />
        </div>
        <div class="col-md-3">
            Cheque Date:
            <input type="date" asp-for="master.PurChqDate" class="form-control" />
        </div>
    </div>
    <div class="row">
        <div class="col-md-3">
            Currency:
            <select asp-for="master.CurId" class="form-control" required="required">
                <option value="">SELECT CURRENCY</option>
                @foreach (var j in Model.lstCurrency)
                {
                    if (@j.CurIsLocal == true)
                    {
                        <option value=@j.CurId selected>@j.CurName</option>
                    }
                    else
                    {
                        <option value=@j.CurId>@j.CurName</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-3">
            Exchange Rate<span class="mandatory">*</span>:
            <input type="number" asp-for="master.PurExRate" onchange="ExchangeRate()" class="form-control" required="required" />
        </div>
        <div class="col-md-3">
            Site:
            <select asp-for="master.SitId" class="form-control" required="required">
                <option value="">SELECT SITE</option>
                @foreach (var j in Model.lstSite)
                {
                    if (@j.SitDefault == true)
                    {
                        <option value=@j.SitId selected>@j.SitName</option>
                    }
                    else
                    {
                        <option value=@j.SitId>@j.SitName</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-3">
            Store<span class="mandatory">*</span>:
            <select asp-for="master.StrId" class="form-control" required="required">                
                <option value="">SELECT STORE</option>
                @foreach (var j in Model.lstStore.OrderBy(x => x.StrId))
                {
                    if (@j.StrDefault == true)
                    {
                        <option value=@j.StrId selected>@j.StrName</option>
                    }
                    else
                    {
                        <option value=@j.StrId>@j.StrName</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-3">
            Supplier<span class="mandatory">*</span>:
            <select asp-for="master.SupId" class="form-control" required="required">
                <option value="-1">SELECT SUPPLIER</option>
                @foreach (var j in Model.lstSupplier)
                {
                    <option value=@j.SupId>@j.SupName</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            Remarks:
            @*<input type="text" asp-for="master.PurRemarks" class="form-control" />*@
            <textarea asp-for="master.PurRemarks" class="form-control textareavertical" rows="1" cols="15"></textarea>
        </div>
    </div>
    <br />
    <div class="row">
        <div class="col-lg-12" style="overflow-x:scroll;">
            <table id="myTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th style="width:250px;">Item<span class="mandatory">*</span></th>
                        <th style="width:70px;">UOM</th>
                        <th style="width:120px;">Last Price</th>
                        <th style="width:120px;">Quantity<span class="mandatory">*</span></th>
                        <th style="width:120px;">Price<span class="mandatory">*</span></th>
                        <th style="width:120px;">Sub. Amount</th>
                        <th style="width:120px;">Disc. Type</th>
                        <th style="width:120px;">Disc.</th>
                        <th style="width:120px;">Disc. Amount</th>
                        <th style="width:120px;">Amt. After Disc.</th>
                        <th style="width:230px;">Excise Slab</th>
                        <th style="width:120px;">Excise Percent</th>
                        <th style="width:120px;">Excise Amount</th>
                        <th style="width:120px;">Amt. After Excise</th>
                        <th style="width:230px;">VAT Slab</th>
                        <th style="width:120px;">VAT Percent</th>
                        <th style="width:120px;">VAT Amount</th>
                        <th style="width:120px;">Net Amount</th>
                        <th style="width:120px;">Exc. Amount</th>
                        <th style="width:230px;">Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < index; i++)
                    {
                    <tr>
                        <td>
                            <select asp-for="detail.detail[i].ItmId" onchange="changeItem(this)" data-rowNo=@i class="chosen-select" style="width:250px;">
                                <option value="-1">SELECT ITEM</option>@foreach (var j in Model.lstItem)
                                {
                                    <option value=@j.ItmId>@j.ItmName</option>}
                            </select>
                        </td>
                        <td><input type="text" asp-for="detail.pdef[i].UOM" readonly="readonly" class="form-control" style="width:70px;" /></td>
                        <td><input type="number" step="any" asp-for="detail.pdef[i].lastPrice" readonly="readonly" class="form-control" style="width:120px;" /></td>
                        <td><input type="number" step="any" asp-for="detail.detail[i].PurQty" data-rowNo=@i onchange="changeQuantityAndRate(this,true)" class="form-control" style="width:120px;" /></td>
                        <td><input type="number" step="any" asp-for="detail.detail[i].PurRate" data-rowNo=@i onchange="changeQuantityAndRate(this,true)" class="form-control" style="width:120px;" /></td>
                        <td><input type="number" step="any" asp-for="detail.pdef[i].subAmount" readonly="readonly" class="form-control" style="width:120px;" /></td>
                        <td><select asp-for="detail.detail[i].PurDisType" data-rowNo=@i onchange="changeQuantityAndRate(this,true)" class="form-control" style="width:120px;"><option value="PERCENT">PERCENT</option><option value="AMOUNT">AMOUNT</option></select></td>
                        <td><input type="number" step="any" asp-for="detail.detail[i].PurDiscountPer" data-rowNo=@i onchange="changeQuantityAndRate(this,true)" class="form-control" style="width:120px;" /></td>
                        <td><input type="number" step="any" asp-for="detail.detail[i].PurDiscountAmt" readonly="readonly" class="form-control" style="width:120px;" /></td>
                        <td><input type="number" step="any" asp-for="detail.pdef[i].AmtAfterDiscount" readonly="readonly" class="form-control" style="width:120px;" /></td>
                        <td>
                            <select asp-for="detail.detail[i].ExciseId" class="form-control" data-rowNo=@i onchange="changeQuantityAndRate(this,true)" style="width:230px;">
                                <option value="-1">SELECT SLAB</option>
                                @foreach (var j in Model.lstExcise)
                                {
                                    <option value=@j.TaxId>@j.TaxName</option>
                                }
                            </select>
                        </td>
                        <td><input type="number" step="any" asp-for="detail.detail[i].PurExPer" readonly="readonly" class="form-control" style="width:120px;" /></td>
                        <td><input type="number" step="any" asp-for="detail.detail[i].PurExAmt" readonly="readonly" class="form-control" style="width:120px;" /></td>
                        <td><input type="number" step="any" asp-for="detail.pdef[i].AmtAfterExcise" readonly="readonly" class="form-control" style="width:120px;" /></td>
                        <td>
                            <select asp-for="detail.detail[i].TaxId" data-rowNo=@i onchange="changeQuantityAndRate(this,true)" class="form-control" style="width:230px;">
                                <option value="-1">SELECT SLAB</option>
                                @foreach (var j in Model.lstTax)
                                {
                                    <option value=@j.TaxId>@j.TaxName</option>
                                }
                            </select>
                        </td>
                        <td><input type="number" step="any" asp-for="detail.detail[i].PurTaxPer" readonly="readonly" class="form-control" style="width:120px;" /></td>
                        <td><input type="number" step="any" asp-for="detail.detail[i].PurTaxAmt" readonly="readonly" class="form-control" style="width:120px;" /></td>
                        <td><input type="number" step="any" asp-for="detail.detail[i].PurNetAmt" readonly="readonly" class="form-control" style="width:120px;" /></td>
                        <td><input type="number" step="any" asp-for="detail.detail[i].PurGrossAmt" readonly="readonly" class="form-control" style="width:120px;" /></td>
                        <td><input type="text" asp-for="detail.detail[i].PurRemarks" class="form-control" style="width:230px;" /></td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</form>


@section Scripts{
    <script type="text/javascript">

        $(window).load(function () {
            ExchangeRate();
        });

        function changeItem(item) {
            var trNo = item.dataset.rowno;
            if (item.value != '-1') {
                $.ajax({
                    type: 'GET',
                    url: '/Transaction/changeItem',
                    data: { id: item.value },
                    dataType: 'json',
                    contentType: "application/json; charset=utf-8",
                    success: function (result) {
                        $('#detail_pdef_' + trNo + '__UOM').val(result.itmUom);
                        $('#detail_pdef_' + trNo + '__lastPrice').val(result.itmSp);
                    },
                    error: function () {
                    }
                })
            }
            else {
                $('#detail_pdef_' + trNo + '__UOM').val('');
                $('#detail_pdef_' + trNo + '__lastPrice').val('');
            }
        }

        function changeQuantityAndRate(QtyRate, Recur) {

            var rowNo = QtyRate.dataset.rowno;
            var ExciseSlab = $('#detail_detail_' + rowNo + '__ExciseId').val();
            var TaxSlab = $('#detail_detail_' + rowNo + '__TaxId').val();
            if (ExciseSlab != '-1') {
                if (Recur == true) {
                    $.ajax({
                        type: 'GET',
                        url: '/Transaction/changeTax',
                        data: { id: ExciseSlab },
                        dataType: 'json',
                        contentType: "application/json; charset=utf-8",
                        success: function (result) {
                            $('#detail_detail_' + rowNo + '__PurExPer').val(result.taxPercent);
                            var subAmount = $('#detail_pdef_' + rowNo + '__AmtAfterDiscount').val();
                            $('#detail_detail_' + rowNo + '__PurExAmt').val((parseFloat(subAmount) * parseFloat(result.taxPercent) / parseFloat(100)).toFixed(2));
                            changeQuantityAndRate(QtyRate, false);
                        },
                        error: function () {
                        }
                    })
                }
            }
            else {
                $('#detail_detail_' + rowNo + '__PurExPer').val('');
                $('#detail_detail_' + rowNo + '__PurExAmt').val('');
            }

            if (TaxSlab != '-1') {
                if (Recur == true) {
                    $.ajax({
                        type: 'GET',
                        url: '/Transaction/changeTax',
                        data: { id: TaxSlab },
                        dataType: 'json',
                        contentType: "application/json; charset=utf-8",
                        success: function (result) {
                            $('#detail_detail_' + rowNo + '__PurTaxPer').val(result.taxPercent);
                            var AmtAfterDisc = $('#detail_pdef_' + rowNo + '__AmtAfterDiscount').val();
                            var AmtExAmt = $('#detail_pdef_' + rowNo + '__PurExAmt').val();
                            $('#detail_detail_' + rowNo + '__PurTaxAmt').val((parseFloat(AmtAfterDisc + AmtExAmt) * parseFloat(result.taxPercent) / parseFloat(100)).toFixed(2));
                            changeQuantityAndRate(QtyRate, false);
                        },
                        error: function () {
                        }
                    })
                }
            }
            else {
                $('#detail_detail_' + rowNo + '__PurTaxPer').val('');
                $('#detail_detail_' + rowNo + '__PurTaxAmt').val('');
            }

            var ExhRate = $('#master_PurExRate').val();
            var qty = $('#detail_detail_' + rowNo + '__PurQty').val();
            var rate = $('#detail_detail_' + rowNo + '__PurRate').val();
            var ExcPercent = $('#detail_detail_' + rowNo + '__PurExPer').val();
            var discount = $('#detail_detail_' + rowNo + '__PurDiscountPer').val();
            var Vat = $('#detail_detail_' + rowNo + '__PurTaxPer').val();
            if (qty != '' && rate != '') {
                $('#detail_pdef_' + rowNo + '__subAmount').val((parseFloat(qty) * parseFloat(rate)).toFixed(2));
                $('#detail_pdef_' + rowNo + '__AmtAfterDiscount').val((parseFloat(qty) * parseFloat(rate)).toFixed(2));
                $('#detail_pdef_' + rowNo + '__AmtAfterExcise').val((parseFloat(qty) * parseFloat(rate)).toFixed(2));
                $('#detail_detail_' + rowNo + '__PurNetAmt').val((parseFloat(qty) * parseFloat(rate)).toFixed(2));
                $('#detail_detail_' + rowNo + '__PurGrossAmt').val((parseFloat(qty) * parseFloat(rate) * parseFloat(ExhRate)).toFixed(2));
                if (discount != '') {
                    var SubAmt = document.getElementById("detail_pdef_" + rowNo + "__subAmount").value;
                    var discType = document.getElementById("detail_detail_" + rowNo + "__PurDisType").value;
                    if (discType == "PERCENT") {
                        $('#detail_detail_' + rowNo + '__PurDiscountAmt').val(parseFloat(SubAmt * discount / 100));
                        $('#detail_pdef_' + rowNo + '__AmtAfterDiscount').val(parseFloat(SubAmt - (SubAmt * discount / 100)).toFixed(2));
                    }
                    if (discType == "AMOUNT") {
                        $('#detail_detail_' + rowNo + '__PurDiscountAmt').val(parseFloat(discount));
                        $('#detail_pdef_' + rowNo + '__AmtAfterDiscount').val(parseFloat(SubAmt - discount).toFixed(2));
                    }
                    var AmtAfterDisc = $('#detail_pdef_' + rowNo + '__AmtAfterDiscount').val();
                    $('#detail_pdef_' + rowNo + '__AmtAfterExcise').val(parseFloat(AmtAfterDisc).toFixed(2));
                    $('#detail_detail_' + rowNo + '__PurNetAmt').val(parseFloat(AmtAfterDisc).toFixed(2));
                    $('#detail_detail_' + rowNo + '__PurGrossAmt').val((parseFloat(AmtAfterDisc) * parseFloat(ExhRate)).toFixed(2));
                }
                else {
                    var AmtAfterDisc = $('#detail_pdef_' + rowNo + '__AmtAfterDiscount').val();
                    $('#detail_detail_' + rowNo + '__PurDiscountPer').val('');
                    $('#detail_detail_' + rowNo + '__PurDiscountAmt').val('');
                    $('#detail_pdef_' + rowNo + '__AmtAfterDiscount').val(AmtAfterDisc);
                }
                var AmountAfterDisc = $('#detail_pdef_' + rowNo + '__AmtAfterDiscount').val();
                if (ExcPercent != '') {
                    $('#detail_detail_' + rowNo + '__PurExAmt').val((parseFloat(AmountAfterDisc) * parseFloat(ExcPercent) / parseFloat(100)).toFixed(2));
                    $('#detail_pdef_' + rowNo + '__AmtAfterExcise').val((parseFloat(AmountAfterDisc) + ((parseFloat(AmountAfterDisc) * parseFloat(ExcPercent)) / 100)).toFixed(2));
                    var afterExcise = $('#detail_pdef_' + rowNo + '__AmtAfterExcise').val();
                    $('#detail_pdef_' + rowNo + '__AmtAfterDiscount').val((parseFloat(AmountAfterDisc)).toFixed(2));
                    $('#detail_detail_' + rowNo + '__PurNetAmt').val(parseFloat(afterExcise).toFixed(2));
                    $('#detail_detail_' + rowNo + '__PurGrossAmt').val((parseFloat(afterExcise) * parseFloat(ExhRate)).toFixed(2));
                }
                if (Vat != '') {
                    var AmtAfterDisc = $('#detail_pdef_' + rowNo + '__AmtAfterDiscount').val();
                    var AmtAfterExc = $('#detail_pdef_' + rowNo + '__AmtAfterExcise').val();
                    $('#detail_detail_' + rowNo + '__PurTaxAmt').val((parseFloat(AmtAfterExc) * parseFloat(Vat) / parseFloat(100)).toFixed(2));
                    $('#detail_detail_' + rowNo + '__PurNetAmt').val((parseFloat(AmtAfterExc) + (parseFloat(AmtAfterExc) * parseFloat(Vat) / parseFloat(100))).toFixed(2));
                    $('#detail_detail_' + rowNo + '__PurGrossAmt').val(((parseFloat(AmtAfterExc) + (parseFloat(AmtAfterExc) * parseFloat(Vat) / parseFloat(100))) * parseFloat(ExhRate)).toFixed(2));
                }
                ExchangeRate();
            }
            else {
                $('#detail_pdef_' + rowNo + '__subAmount').val('');
                $('#detail_pdef_' + rowNo + '__AmtAfterDiscount').val('');
                $('#detail_pdef_' + rowNo + '__AmtAfterExcise').val('');
                $('#detail_detail_' + rowNo + '__PurNetAmt').val('');
                $('#detail_detail_' + rowNo + '__PurGrossAmt').val('');
                ExchangeRate();
            }
        }

        function ExchangeRate() {

            var ExRate = $('#master_PurExRate').val();
            var rows = $('#myTable tbody tr').length;
            var subAmountTotal = 0;
            var ExciseTotal = 0;
            var TaxTotal = 0;
            var TotalDiscount = 0;
            for (var i = 0; i < rows; i++) {
                var NetAmount = $('#detail_detail_' + i + '__PurNetAmt').val();
                NetAmount = (NetAmount == '') ? 0 : NetAmount;
                var ExciseAmount = $('#detail_detail_' + i + '__PurExAmt').val();
                ExciseAmount = (ExciseAmount == '') ? 0 : ExciseAmount;
                var TaxAmount = $('#detail_detail_' + i + '__PurTaxAmt').val();
                TaxAmount = (TaxAmount == '') ? 0 : TaxAmount;
                var Amount = $('#detail_pdef_' + i + '__subAmount').val();
                Amount = (Amount == '') ? 0 : Amount;
                var Discount = $('#detail_detail_' + i + '__PurDiscountAmt').val();
                Discount = (Discount == '') ? 0 : Discount;
                if (NetAmount != '') {
                    $('#detail_detail_' + i + '__PurGrossAmt').val((parseFloat(NetAmount) * parseFloat(ExRate)).toFixed(2));
                    subAmountTotal += parseFloat(Amount);
                    ExciseTotal += parseFloat(ExciseAmount);
                    TaxTotal += parseFloat(TaxAmount);
                    TotalDiscount += parseFloat(Discount);
                }
            }
            $('#SubTotal').val(subAmountTotal);
            $('#ExciseTax').val(ExciseTotal);
            $('#VAT').val(TaxTotal);
            $('#TotalAmount').val((parseFloat(subAmountTotal + ExciseTotal + TaxTotal - TotalDiscount) * parseFloat(ExRate)).toFixed(2));

            $.ajax({
                type: 'GET',
                url: '/Transaction/purchaseTotalAmount',
                data: { RefCode: $('#master_PurPoref').val(), PaidType: $('#master_PurPayTerm').val() },
                dataType: 'json',
                async: false,
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    if (result != undefined) { $('#Paid').val(result); } else { $('#Paid').val('0'); }
                },
                error: function () {
                }
            })

            var TAmount = $('#TotalAmount').val();
            var TAdvance = $('#Advance').val();
            var TPaid = $('#Paid').val();
            if ($('#master_PurPayTerm').val() == "CREDIT") {
                $('#TotalBalance').val((parseFloat(TAmount) - parseFloat(TPaid)));
            }
            else {
                $('#TotalBalance').val('0');
                $('#Paid').val(TAmount);
            }
        }

        $('#addNewRow').click(function (event) {
            var rowCount = $('#myTable tbody tr').length;
            var dropDownItm = document.getElementById('detail_detail_0__ItmId').innerHTML;
            var dropDownExcise = document.getElementById('detail_detail_0__ExciseId').innerHTML;
            var dropDownTax = document.getElementById('detail_detail_0__TaxId').innerHTML;
            $('#myTable').append('<tr><td><select onchange="changeItem(this)" data-rowno="' + rowCount + '" class="chosen-select" style="width:250px;" id="detail_detail_' + rowCount + '__ItmId" name="detail.detail[' + rowCount + '].ItmId">' + dropDownItm + '</select ></td><td><input type="text" readonly="readonly" class="form-control" style="width:70px;" id="detail_pdef_' + rowCount + '__UOM" name="detail.pdef[' + rowCount + '].UOM" value=""></td><td><input type="number" step="any" readonly="readonly" class="form-control" style="width:120px;" data-val="true" data-val-number="The field lastPrice must be a number." id="detail_pdef_' + rowCount + '__lastPrice" name="detail.pdef[' + rowCount + '].lastPrice" value=""></td><td><input type="number" step="any" data-rowno="' + rowCount + '" onchange="changeQuantityAndRate(this,true)" class="form-control" style="width:120px;" data-val="true" data-val-number="The field PurQty must be a number." id="detail_detail_' + rowCount + '__PurQty" name="detail.detail[' + rowCount + '].PurQty" value=""></td><td><input type="number" step="any" data-rowno="' + rowCount + '" onchange="changeQuantityAndRate(this,true)" class="form-control" style="width:120px;" data-val="true" data-val-number="The field PurRate must be a number." id="detail_detail_' + rowCount + '__PurRate" name="detail.detail[' + rowCount + '].PurRate" value=""></td><td><input type="number" step="any" readonly="readonly" class="form-control" style="width:120px;" data-val="true" data-val-number="The field subAmount must be a number." id="detail_pdef_' + rowCount + '__subAmount" name="detail.pdef[' + rowCount + '].subAmount" value=""></td><td><select data-rowno="' + rowCount + '" onchange="changeQuantityAndRate(this,true)" class="form-control" style="width:120px;" id="detail_detail_' + rowCount + '__PurDisType" name="detail.detail[' + rowCount + '].PurDisType"><option value="PERCENT">PERCENT</option><option value="AMOUNT">AMOUNT</option></select></td><td><input type="number" step="any" data-rowno="' + rowCount + '" onchange="changeQuantityAndRate(this,true)" class="form-control" style="width:120px;" data-val="true" data-val-number="The field PurDiscountPer must be a number." id="detail_detail_' + rowCount + '__PurDiscountPer" name="detail.detail[' + rowCount + '].PurDiscountPer" value=""></td><td><input type="number" step="any" readonly="readonly" class="form-control" style="width:120px;" data-val="true" data-val-number="The field PurDiscountAmt must be a number." id="detail_detail_' + rowCount + '__PurDiscountAmt" name="detail.detail[' + rowCount + '].PurDiscountAmt" value=""></td><td><input type="number" step="any" readonly="readonly" class="form-control" style="width:120px;" data-val="true" data-val-number="The field AmtAfterDiscount must be a number." id="detail_pdef_' + rowCount + '__AmtAfterDiscount" name="detail.pdef[' + rowCount + '].AmtAfterDiscount" value=""></td><td><select class="form-control" data-rowno="' + rowCount + '" onchange="changeQuantityAndRate(this,true)" style="width:230px;" id="detail_detail_' + rowCount + '__ExciseId" name="detail.detail[' + rowCount + '].ExciseId">' + dropDownExcise + '</select ></td><td><input type="number" step="any" readonly="readonly" class="form-control" style="width:120px;" data-val="true" data-val-number="The field PurExPer must be a number." id="detail_detail_' + rowCount + '__PurExPer" name="detail.detail[' + rowCount + '].PurExPer" value=""></td><td><input type="number" step="any" readonly="readonly" class="form-control" style="width:120px;" data-val="true" data-val-number="The field PurExAmt must be a number." id="detail_detail_' + rowCount + '__PurExAmt" name="detail.detail[' + rowCount + '].PurExAmt" value=""></td><td><input type="number" step="any" readonly="readonly" class="form-control" style="width:120px;" data-val="true" data-val-number="The field AmtAfterExcise must be a number." id="detail_pdef_' + rowCount + '__AmtAfterExcise" name="detail.pdef[' + rowCount + '].AmtAfterExcise" value=""></td><td><select data-rowno="' + rowCount + '" onchange="changeQuantityAndRate(this,true)" class="form-control" style="width:230px;" id="detail_detail_' + rowCount + '__TaxId" name="detail.detail[' + rowCount + '].TaxId">' + dropDownTax + '</select ></td><td><input type="number" step="any" readonly="readonly" class="form-control" style="width:120px;" data-val="true" data-val-number="The field PurTaxPer must be a number." id="detail_detail_' + rowCount + '__PurTaxPer" name="detail.detail[' + rowCount + '].PurTaxPer" value=""></td><td><input type="number" step="any" readonly="readonly" class="form-control" style="width:120px;" data-val="true" data-val-number="The field PurTaxAmt must be a number." id="detail_detail_' + rowCount + '__PurTaxAmt" name="detail.detail[' + rowCount + '].PurTaxAmt" value=""></td><td><input type="number" step="any" readonly="readonly" class="form-control" style="width:120px;" data-val="true" data-val-number="The field PurNetAmt must be a number." id="detail_detail_' + rowCount + '__PurNetAmt" name="detail.detail[' + rowCount + '].PurNetAmt" value=""></td><td><input type="number" step="any" readonly="readonly" class="form-control" style="width:120px;" data-val="true" data-val-number="The field PurGrossAmt must be a number." id="detail_detail_' + rowCount + '__PurGrossAmt" name="detail.detail[' + rowCount + '].PurGrossAmt" value=""></td><td><input type="text" class="form-control" style="width:230px;" id="detail_detail_' + rowCount + '__PurRemarks" name="detail.detail[' + rowCount + '].PurRemarks" value=""></td></td></tr>')
            $('#detail_detail_' + rowCount + '__ItmId').attr('Selected', true).val("-1");
            $('#detail_detail_' + rowCount + '__ExciseId').attr('Selected', true).val("-1");
            $('#detail_detail_' + rowCount + '__TaxId').attr('Selected', true).val("-1");
            event.preventDefault();
            $(".chosen-select").chosen('destroy');
        })

        $(document).ready(function () {
            $('#Save').on('click', function (event) {
                var count = 0;
                var rowCount = $('#myTable tbody tr').length;
                var TRTotalAmount = $('#TotalAmount').val();
                if (parseFloat(TRTotalAmount) < 0) {
                    alert('Cannot Save Negative Transaction!');
                    event.preventDefault();
                    return;
                }
                if ($('#master_PurPayTerm').val() != 'CREDIT' && $('#master_Coaid').val() == '') {
                    alert('Please Select Cash / Bank!');
                    event.preventDefault();
                    return;
                }
                if ($('#master_SupId').val() == '-1') {
                    alert('Please Select any Supplier!');
                    event.preventDefault();
                    return;
                }
                //if ($('#master_PurPayTerm').val() == 'CREDIT' && parseFloat($('#Advance').val()) != 0 && $('#master_Coaid').val() == '') {
                //    alert('Please Select Cash / Bank!');
                //    event.preventDefault();
                //    return;
                //}
                if (parseFloat($('#master_PurExRate').val()) == 0 || $('#master_PurExRate').val() == '') {
                    alert('Please Enter Valid Exchange Rate!');
                    event.preventDefault();
                    return;
                }
                for (var i = 0; i < rowCount; i++) {
                    if ($('#detail_detail_' + i + '__PurQty').val() != '' &&
                        $('#detail_detail_' + i + '__PurRate').val() != '' &&
                        $('#detail_detail_' + i + '__ItmId').val() != '-1') {
                        count++;
                    }
                }
                if (parseFloat(count) == 0) {
                    alert('Please Select Item or Enter Quantity or Rate!');
                    event.preventDefault();
                    return;
                }
            })
        })

        $(document).ready(function () {
            $('#Update').on('click', function (event) {
                var count = 0;
                var rowCount = $('#myTable tbody tr').length;
                var TRTotalAmount = $('#TotalAmount').val();
                if (parseFloat(TRTotalAmount) < 0) {
                    alert('Cannot Save Negative Transaction!');
                    event.preventDefault();
                    return;
                }
                if ($('#master_PurPayTerm').val() != 'CREDIT' && $('#master_Coaid').val() == '') {
                    alert('Please Select Cash / Bank!');
                    event.preventDefault();
                    return;
                }
                if ($('#master_SupId').val() == '-1') {
                    alert('Please Select any Supplier!');
                    event.preventDefault();
                    return;
                }
                //if ($('#master_PurPayTerm').val() == 'CREDIT' && parseFloat($('#Advance').val()) != 0 && $('#master_Coaid').val() == '-1') {
                //    alert('Please Select Cash / Bank!');
                //    event.preventDefault();
                //    return;
                //}
                if (parseFloat($('#master_PurExRate').val()) == 0) {
                    alert('Please Enter Valid Exchange Rate!');
                    event.preventDefault();
                    return;
                }
                for (var i = 0; i < rowCount; i++) {
                    if ($('#detail_detail_' + i + '__PurQty').val() != '' &&
                        $('#detail_detail_' + i + '__PurRate').val() != '' &&
                        $('#detail_detail_' + i + '__ItmId').val() != '-1') {
                        count++;
                    }
                }
                if (parseFloat(count) == 0) {
                    alert('Please Select Item or Enter Quantity or Rate!');
                    event.preventDefault();
                    return;
                }
            })
        })

        $(document).ready(function () {
            $('#master_PurPayTerm').change(function () {
                var term = $('#master_PurPayTerm').val();
                var Account = "<option value=''>SELECT ACCOUNT</option>";
                $.ajax({
                    type: 'GET',
                    url: '/Transaction/changeTerm',
                    data: { Term: term },
                    dataType: 'json',
                    contentType: "application/json; charset=utf-8",
                    success: function (result) {
                        for (var i = 0; i < result.length; i++) {
                            Account += "<option value='" + result[i].coaid + "'>" + result[i].accName + "</option>";
                        }
                        $('#master_Coaid option').remove();
                        $('#master_Coaid').append(Account);
                    },
                    error: function () {
                    }
                })
                debugger;
                if (term == 'CREDIT') {
                    $('#Advance').removeAttr("readonly");
                    if (parseFloat($('#Advance').val()) > (parseFloat($('#TotalAmount').val() - parseFloat($('#Paid').val()))))
                    {
                        $('#Advance').val('0');
                    }
                    ExchangeRate();
                }
                else {
                    $('#Advance').val('0');
                    if (parseFloat($('#Advance').val()) > (parseFloat($('#TotalAmount').val() - parseFloat($('#Paid').val()))))
                    {
                        $('#Advance').val('0');
                    }
                    ExchangeRate();
                    $('#Advance').attr('readonly', 'readonly');
                    $('#master_PurChqNo').val('');
                    $('#master_PurChqDate').val('');
                }
            })
        })

        $(document).ready(function () {
            $('#Advance').change(function () {
                if ($('#Advance').val() > (parseFloat($('#TotalAmount').val()) - parseFloat($('#Paid').val())))
                {
                    $('#Advance').val('0')
                }
                ExchangeRate();
            })
        })

        if ($('#master_PurPayTerm').val() == 'CREDIT') { $('#Advance').removeAttr("readonly"); } else { $('#Advance').attr('readonly', 'readonly'); }

    </script>

}
